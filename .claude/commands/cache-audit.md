# /cache-audit - 백엔드 캐싱 및 데이터 호출 최적화 감사

백엔드 성능 최적화 전문가이자 Next.js 데이터 아키텍트로서, 프로젝트에서 불필요한 DB/API 중복 호출을 찾고 Next.js 캐싱 메커니즘을 통해 서버 부하를 줄이는 최적화 리포트를 작성합니다.

---

## 분석 절차

### 1단계: Request Memoization (중복 제거) 점검
Layout과 Page, 혹은 여러 컴포넌트에서 동일한 데이터를 가져오는 함수를 분석합니다:
- `import { cache } from 'react'`로 래핑되지 않은 서버 데이터 호출 함수 식별
- Layout → Page → Component 간 동일 데이터 중복 호출 패턴 탐지
- Props로 깊게 전달하는(Prop Drilling) 대신 필요한 곳에서 직접 호출하도록 구조 변경 제안

### 2단계: Data Cache (영구 캐싱) 적용
매 요청마다 불필요하게 실행되는 데이터 호출을 찾습니다:
- `fetch()` 호출에 `{ next: { revalidate } }` 옵션이 누락되거나 `revalidate: 0`이 과도하게 설정된 곳 식별
- DB 직접 호출(Prisma 등)에 `unstable_cache` 적용 가능한 지점 식별 및 코드 제안
- 커스텀 인메모리 캐시를 Next.js 네이티브 캐시로 대체할 수 있는 부분 제안

### 3단계: 캐시 무효화(Revalidation) 전략
데이터 변경(Mutation) 후 캐시를 정확히 갱신하는 전략을 수립합니다:
- 모든 Mutation 엔드포인트(POST/PATCH/DELETE) 및 Server Action 식별
- 각 Mutation에 대응하는 `tags` 설정과 `revalidateTag` 매핑 제안
- 시간 기반(`revalidate`) vs 온디맨드(`revalidateTag`) 전략 구분

### 4단계: 클라이언트 사이드 캐싱 점검
TanStack Query 등 클라이언트 캐싱 설정을 분석합니다:
- `staleTime`, `refetchInterval` 설정의 적절성 평가
- Server Component에서 이미 조회한 데이터를 Client Component에서 다시 요청하는 패턴 식별
- `initialData` 또는 `hydration` 패턴으로 중복 제거 제안

### 5단계: 쿼리 효율성 점검
비효율적인 DB 쿼리 패턴을 찾습니다:
- N+1 쿼리 패턴 (루프 내 개별 쿼리)
- 전체 조회 후 메모리 필터링 (COUNT 쿼리로 대체 가능)
- 병렬 실행 가능한 순차 쿼리

---

## 출력 형식

```markdown
## 캐싱 최적화 리포트 (YYYY-MM-DD)

### 1. 요약 대시보드

| 지표 | 현재 | 최적화 후 (예상) |
|------|------|-----------------|
| 요청당 평균 DB 쿼리 수 | ? | ? |
| 중복 호출 함수 수 | ? | 0 |
| 캐싱 미적용 데이터 함수 수 | ? | 0 |
| 예상 서버 부하 감소율 | - | ~?% |

### 2. 함수별 상세 분석표

| # | 함수명 | 위치 | 호출 지점 | 현재 상태 (AS-IS) | 문제 유형 | 개선 제안 (TO-BE) | 캐시 TTL | 예상 효과 |
|---|--------|------|----------|-------------------|----------|------------------|----------|----------|
| 1 | 예시 | 파일:라인 | Page, Layout | 설명 | 유형 | 제안 | TTL | 효과 |

### 3. 개선 코드 (함수별)

// ❌ AS-IS — 현재 코드
// ✅ TO-BE — 개선 코드 (변경 이유를 인라인 주석으로)

### 4. 캐시 무효화 매핑표

| Mutation 동작 | 무효화 대상 태그 | 호출 위치 | 코드 예시 |
|--------------|----------------|----------|----------|
| 예시 동작 | `tag-name` | Server Action / API Route | `revalidateTag('tag-name')` |

### 5. 적용 우선순위

| 우선순위 | 항목 | 영향도 | 난이도 | 비고 |
|---------|------|-------|-------|------|
| P0 | 가장 시급한 항목 | 높음 | 낮음 | 사유 |
| P1 | 다음 항목 | 높음 | 중간 | 사유 |
| P2 | 선택 항목 | 중간 | 중간 | 사유 |
```
