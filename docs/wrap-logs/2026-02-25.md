# Wrap 로그 2026-02-25

## 세션 1 (11:40)

### 작업 요약

| 카테고리 | 내용 |
|----------|------|
| 수정 파일 | 23개 (+1,081 / -650 라인) |
| 신규 파일 | 61개 |
| 테스트 | 신규 22개 (unit 16 + integration 1 + e2e 5) |

### 핵심 변경사항

- **[기능] AI 챗봇 강화 18태스크 전체 완료** (4 Wave)
  - 의도 분류 (IntentClassifier + ChatIntent 값 객체)
  - 프롬프트 템플릿 (PromptTemplateService + FewShotExampleRegistry)
  - 회복력 (CircuitBreaker + withRetry + ResilienceService + FallbackResponse)
  - 대화 요약 (ConversationSummarizerService)
  - 가이드 질문 (GuideQuestionService)
  - 피드백 시스템 (ChatMessageFeedback + useFeedback + GetFeedbackAnalyticsUseCase)
  - 접근성 (키보드 내비게이션 + ARIA + 스크린리더)
- **[기능] 감사 보고서 PDF 생성 + 공유 링크**
- **[기능] 최적화 규칙 관리 UI** (테이블+폼+프리셋)
- **[인프라] DI 토큰 6개 추가** (ResilienceService, PromptTemplateService, FallbackResponseService, FewShotExampleRegistry, GuideQuestionService, GetFeedbackAnalyticsUseCase)
- **[스킬] verify-* 3개 스킬 업데이트** (채팅/최적화 커버리지 추가)

### 검증 결과

- verify-architecture: PASS (4/4)
- verify-di-registration: PASS (5/5)
- verify-cache-tags: PASS
- verify-bundle: PASS
- verify-meta-api-version: PASS
- verify-token-encryption: PASS
- verify-ui-components: PASS (7/7)

### 해결된 이슈

- AI 챗봇 의도 분류 누락 → IntentClassifier 도메인 서비스
- 외부 API 장애 시 무응답 → CircuitBreaker + withRetry + FallbackResponse
- 챗봇 접근성 부족 → 키보드 내비게이션 + ARIA
- verify-ui-components zsh `!` 비호환 → Grep 도구 기반 전환

### 미해결 사항

- 없음

---

### 다음 작업 To-Do

#### P0
- [ ] 커밋 생성 — 23개 수정 + 61개 신규 파일
- [ ] Prisma migrate 필요 여부 확인

#### P1
- [ ] E2E 테스트 실행 확인 (신규 5개 스펙)
- [ ] 감사 PDF/공유 API 보안 검토

### 백로그 변동
- 신규 이관: 0개 | 완료 제거: 0개
- 현재 총: P2a 3개, P2b 8개

---

## 세션 2 (13:48)

### 작업 요약

| 카테고리 | 내용 |
|----------|------|
| 수정 파일 | 7개 (+29 / -11 라인) |
| 신규 파일 | 0개 |
| 테스트 | 기존 2,674개 전부 통과 |

### 변경 파일 (7개)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/app/api/platform/cafe24/callback/route.ts` | 수정 | accessToken 저장 시 `encryptToken()` 적용 (P0 보안) |
| `src/app/api/platform/cafe24/inject/route.ts` | 수정 | accessToken 사용 시 `safeDecryptToken()` 적용 (P0 보안) |
| `src/app/api/platform/cafe24/disconnect/route.ts` | 수정 | accessToken 사용 시 `safeDecryptToken()` 적용 (P0 보안) |
| `src/lib/cache/oauthCache.ts` | 수정 | OAuthSession 저장/조회에 암복호화 적용 (P1 보안) |
| `src/lib/di/types.ts` | 수정 | `ConversationSummarizerService` 토큰 추가 |
| `src/lib/di/container.ts` | 수정 | `ConversationSummarizerService` DI 등록 + 편의 함수 |
| `src/presentation/components/pixel/guides/NaverGuide.tsx` | 수정 | 추적 픽셀 `<img>`에 `alt=""` 추가 (접근성) |

### 핵심 변경사항

- **[보안/P0] Cafe24 토큰 암복호화 적용** — callback(저장), inject/disconnect(조회) 3개 API에 AES-256-GCM 암복호화. Meta 경로와 동일한 보안 수준으로 통일
- **[보안/P1] OAuthSession 암호화** — 10분 TTL 임시 캐시지만 DB 저장 시 encryptToken, 조회 시 safeDecryptToken 적용
- **[DI] ConversationSummarizerService 등록** — types.ts 토큰 + container.ts 팩토리 + 편의 함수 추가
- **[접근성] NaverGuide 추적 픽셀 alt 속성** — 인라인 스니펫의 noscript img에 `alt=""` 추가

### 검증 결과 (7개 스킬 병렬 실행)

| 스킬 | 상태 | 비고 |
|------|------|------|
| verify-architecture | PASS | 레이어 위반 0건 |
| verify-di-registration | PASS → 수정 후 PASS | ConversationSummarizerService 등록 완료 |
| verify-cache-tags | PASS | 38건 revalidateTag 모두 2인자 형식 |
| verify-bundle | PASS | namespace import/dev-only 누출 0건 |
| verify-meta-api-version | PASS | 4파일 모두 v25.0 |
| verify-token-encryption | FAIL → 수정 후 PASS | Cafe24 3파일 + OAuthSession 1파일 암복호화 적용 |
| verify-ui-components | PASS | 91/100점 (A-) |

### 최종 검증

- `tsc --noEmit`: PASS
- `vitest run`: 173 파일, 2,674 테스트 PASS
- `next build`: PASS (exit 0)

### 해결된 이슈

- Cafe24 OAuth 토큰이 DB에 평문 저장되던 보안 취약점 (P0)
- OAuthSession 임시 캐시의 Meta 토큰 평문 노출 (P1)
- ConversationSummarizerService DI 미등록 (P1)
- NaverGuide 추적 픽셀 alt 속성 누락 (P2)
- verify-di-registration GuideQuestionService 오탐 확인 (이미 types.ts:160에 존재)

### 미해결 사항

- 없음

---

### 다음 작업 To-Do

#### P0
- [ ] 커밋 생성 — 보안 수정 7개 파일 (관련: `src/app/api/platform/cafe24/`)

#### P1
- [ ] AdSet/Creative/Asset mutation API에 revalidateTag 추가 (8개 API, 관련: `src/app/api/adsets/`, `src/app/api/creatives/`, `src/app/api/assets/`)
- [ ] `admin-analytics` 태그 정리 — revalidateTag 미사용 태그 (관련: `src/app/(admin)/admin/analytics/page.tsx`)

### 백로그 변동
- 신규 이관: 1개 (P2b: AdSet/Creative revalidateTag)
- 완료 제거: 0개
- 현재 총: P2a 3개, P2b 9개 → [docs/backlog.md](../backlog.md)

---

## 세션 3 (23:12)

### 작업 요약

| 카테고리 | 내용 |
|----------|------|
| 수정 파일 | 6개 (+391 / -2,403 라인) |
| 삭제 파일 | 4개 (레거시 코드 1,660라인 제거) |
| 테스트 | 171 파일, 2,662 테스트 PASS |

### 변경 파일 (12개)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/infrastructure/external/errors/ResilienceService.ts` | 수정 | CB 인스턴스 `Map` 캐싱 추가 — 장애 격리 정상화 |
| `src/app/api/agent/chat/route.ts` | 수정 | Rate Limit 추가 (user+IP 복합키, X-RateLimit 헤더) |
| `src/application/services/ConversationalAgentService.ts` | 수정 | Phase 분리 리팩토링 + IntentClassifier 연결 + 레거시 제거 |
| `src/lib/di/container.ts` | 수정 | AgentContext에 실제 Meta 토큰 주입 (DB 조회 + 복호화) |
| `tests/integration/chat/agent-migration.test.ts` | 수정 | 레거시 파일 삭제 검증으로 전환 |
| `tests/unit/.../ConversationalAgentService.resilience.test.ts` | 수정 | 새 아키텍처(Phase1=db-setup, Phase2=직접 스트리밍) 반영 |
| `src/app/api/ai/chat/route.ts` | **삭제** | 레거시 라우트 306라인 제거 |
| `src/application/services/ChatService.ts` | **삭제** | 레거시 서비스 813라인 제거 |
| `tests/unit/.../ChatService.test.ts` | **삭제** | 레거시 테스트 528라인 제거 |
| `tests/unit/.../ConversationalAgentService.migration.test.ts` | **삭제** | 마이그레이션 테스트 13라인 제거 |
| `.claude/CLAUDE.md` | 수정 | 프로젝트 에이전트 설정 업데이트 |
| `.claude/skills/hephaestus/SKILL.md` | **삭제** | 미사용 스킬 제거 |

### 핵심 변경사항 (7건 수정, 권장 순서대로)

1. **[P0/버그] CB 인스턴스 캐싱** — `ResilienceService.circuitBreaker()`가 매 호출 새 인스턴스 생성 → `Map<string, ICircuitBreaker>` 캐시로 장애 상태 공유 정상화
2. **[P1-4/보안] Rate Limit 추가** — `/api/agent/chat`에 `checkRateLimit()` 적용, 레거시와 동일 수준의 비용 통제
3. **[P0/성능] 스트리밍 리팩토링** — 가짜 스트리밍(배치 수집→재방출) → 진짜 스트리밍(Phase1: DB+retry+CB, Phase2: LLM 직접 yield). 체감 응답시간 2-5초 단축
4. **[P1-1/기능] AgentContext 토큰 주입** — `buildAgentContext`에서 하드코딩 null → DB 조회 + `safeDecryptToken()`. Meta 동기화 정상화
5. **[P1-3/버그] Retry+CB 이중 래핑 해소** — Phase 분리로 자동 해결. DB 작업 중복 실행 방지
6. **[P2-2/최적화] IntentClassifier 연결 + 동적 프롬프트** — 정적 시스템 프롬프트 ~4,000토큰 → 인텐트별 동적 생성 ~1,500토큰. 추천 질문도 인텐트 기반으로 전환
7. **[P1-2/정리] 레거시 제거** — `/api/ai/chat` + `ChatService` + 관련 테스트 삭제 (1,660라인 제거)

### 최종 검증

- `tsc --noEmit`: PASS
- `vitest run`: 171 파일, 2,662 테스트 PASS
- `next build`: PASS (exit 0)

### 해결된 이슈

- CB 인스턴스 비캐싱으로 장애 격리 무효화 (N1/P0)
- 가짜 스트리밍으로 인한 2-5초 지연 (N2/P0)
- `/api/agent/chat` Rate Limit 부재 → OpenAI 비용 무제한 (P1-4)
- AgentContext 토큰 하드코딩 null → Meta 동기화 불가 (P1-1)
- Retry+CB 이중 래핑 → DB 작업 중복 실행 (P1-3)
- 정적 시스템 프롬프트 비대화 → 토큰 낭비 (P2-2)
- 추천 질문 키워드 매칭 → 맥락 무관 반복 (P2-1)
- 레거시 ChatService + /api/ai/chat 미제거 (P1-2)

### 미해결 사항

- P2-3: AgentStreamChunk 타입 서버/클라이언트 이중 정의 → 공유 타입 도입 필요
- P2-4: toCoreMessages()에서 tool 메시지 제외 → LLM 도구 결과 참조 불가
- P2-5: Domain/Application IntentClassifier 이름 중복 → 리네이밍 필요
- P3-1: SSE 파싱 불완전 → eventsource-parser 도입 권장
- P3-2: 클라이언트×서버 이중 재시도 → 최대 12회 LLM 호출 가능
- P3-3: 마크다운 렌더링 시 XSS 방어 미비

---

### 다음 작업 To-Do

#### P0
- [ ] 커밋 생성 — AI 챗봇 7건 수정 12개 파일 (관련: `src/application/services/ConversationalAgentService.ts`)

#### P1
- [ ] P2-4 수정: `toCoreMessages()`에 tool 메시지 포함 (관련: `src/application/services/ConversationalAgentService.ts`)
- [ ] P3-2 수정: 클라이언트 재시도 제거하여 이중 재시도 방지 (관련: `src/presentation/hooks/useAgentChat.ts`)

### 백로그 변동
- 신규 이관: 4개 (P2b: 4개)
- 완료 제거: 0개
- 현재 총: P2a 3개, P2b 13개 → [docs/backlog.md](../backlog.md)
