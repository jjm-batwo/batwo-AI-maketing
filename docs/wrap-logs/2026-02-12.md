# 작업 요약 (2026-02-12)

## 변경 파일 (6개 핵심)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `CLAUDE.md` | 수정 | TDD 가이드라인 추가, 미구현 슬래시 커맨드/AI팀 시스템/Plan Mode 다이어그램 제거 (375→207줄, 45% 감소) |
| `.claude/CLAUDE.md` | 수정 | OMC 보일러플레이트 제거, 프로젝트 에이전트 설정으로 교체 (689→51줄, 93% 감소) |
| `src/presentation/components/landing/HeroSection/HeroContent.tsx` | 수정 | 타이틀/CTA 버튼 반응형 브레이크포인트 단계적 적용 |
| `src/presentation/components/landing/HeroSection/AIChatDemo.tsx` | 수정 | 채팅 영역 높이 반응형 처리 (`h-[300px] lg:h-[320px] xl:h-[400px]`) |
| `src/presentation/components/landing/PricingSection/PricingSection.tsx` | 수정 | 4열 그리드 `xl:grid-cols-4`, 인기 플랜 스케일 `xl:scale-105` |
| `src/presentation/components/landing/ProductShowcaseSection.tsx` | 수정 | KPI 값 텍스트 크기 `text-base lg:text-xl` |

## 핵심 변경사항

- **[지침 개선]** CLAUDE.md에 TDD 개발 가이드라인 추가 (Red→Green→Refactor, Self-Healing 규칙, 레이어별 테스트 전략)
- **[지침 정리]** .claude/CLAUDE.md에서 OMC 보일러플레이트 689줄 제거 → 51줄 프로젝트 에이전트 설정으로 교체
- **[지침 정리]** CLAUDE.md에서 미구현 슬래시 커맨드(/상태, /기능요청 등), AI 개발팀 시스템, Plan Mode 플로우 다이어그램, UX/UI 팀 섹션 제거
- **[반응형 수정]** 랜딩페이지 4개 컴포넌트에서 1024-1440px 노트북 해상도 대응 브레이크포인트 추가 (lg→xl→2xl 단계적 적용)

## 해결된 이슈

- CLAUDE.md 지침 파일 비대화 문제: 전체 1,064→258줄 (76% 컨텍스트 절약)
- 4K 모니터에서만 정상이던 랜딩페이지가 1366x768 노트북에서 타이틀/버튼 과대, 채팅 영역 넘침, 가격표 겹침 발생 → 해결
- Playwright MCP 스크린샷 타임아웃: 웹폰트 로딩 대기로 5초 타임아웃 초과 → Node.js 스크립트 직접 실행으로 우회

## 미해결 사항

- Playwright headless 브라우저 chromium 재설치 필요했음 (버전 업데이트 후 캐시 무효화)
- 전체 페이지 스크린샷에서 `useIntersectionObserver` 사용 섹션이 `opacity-0`으로 보이지 않음 (headless 환경에서 스크롤 트리거 불가)

---

## 규칙/메모리 업데이트

### 새로 배운 패턴

- **Playwright MCP 스크린샷 타임아웃**: 웹폰트(Pretendard 등) 로딩 시 5초 제한 초과 → `node -e` + `require('playwright')` 직접 실행으로 우회 가능
- **반응형 디자인 검증**: 4K에서만 테스트하면 노트북(1366x768)에서 깨짐 → `lg`(1024px)와 `xl`(1280px) 사이 브레이크포인트 필수 확인
- **CSS-only 변경은 TDD 불필요**: Tailwind 클래스 변경은 비즈니스 로직 없음 → 브라우저 시각적 검증이 적절

---

## 다음 작업 To-Do

### 우선순위 높음 (P0)

- [ ] 랜딩페이지 추가 해상도 테스트: 768px(태블릿), 375px(모바일) 뷰포트에서도 정렬 확인 (관련 파일: `src/presentation/components/landing/`)
- [ ] `useIntersectionObserver` E2E 테스트 개선: headless 브라우저에서 스크롤 트리거 후 섹션 가시성 검증 (관련 파일: `tests/e2e/landing.spec.ts`)

### 우선순위 보통 (P1)

- [ ] 전체 테스트 실행 확인: `npx vitest run` (2,138 테스트 전체 통과 여부)
- [ ] Meta 앱 검수 스크린캐스트 녹화 진행 (관련 파일: `docs/meta-app-review/RECORDING_SCRIPT.md`)
- [ ] 백엔드 완성도 분석 및 구현 (관련 파일: `docs/03-analysis/backend-completion.analysis.md`)

### 나중에 (P2)

- [ ] Playwright MCP 스크린샷 타임아웃 근본 해결: 폰트 프리로드 또는 MCP 타임아웃 설정 조정
- [ ] 랜딩페이지 섹션별 성능 최적화: intersection observer 애니메이션 지연 로딩 검토

---

## 세션 2 (22:12) - 번들 최적화

### 변경 파일 (5개)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/lib/errors/reportError.ts` | 수정 | Sentry `import *` → named imports로 트리 쉐이킹 최적화 |
| `src/app/error.tsx` | 수정 | Sentry `import *` → named imports로 트리 쉐이킹 최적화 |
| `src/app/providers.tsx` | 수정 | ReactQueryDevtools `lazy()` + `Suspense` + dev-only 조건부 로딩 |
| `package.json` | 수정 | `@tanstack/react-query-devtools`, `swagger-ui-react`, `@types/swagger-ui-react` → devDependencies 이동 |
| `src/app/docs/page.tsx` | 수정 | swagger-ui-react 프로덕션 완전 제외 (`process.env.NODE_ENV` 가드), CSS 조건부 로드 |

### 신규 파일 (1개)

| 파일 | 유형 | 설명 |
|------|------|------|
| `.claude/commands/bundle-audit.md` | 신규 | `/bundle-audit` 커스텀 커맨드 - 번들 최적화 감사 5단계 분석 |

### 핵심 변경사항

- **[최적화]** Sentry namespace import(`import * as Sentry`) → named imports로 변환하여 트리 쉐이킹 활성화 (2개 파일)
- **[최적화]** ReactQueryDevtools를 `React.lazy()` + `Suspense`로 변경, 프로덕션 번들에서 제외
- **[최적화]** swagger-ui-react(1.1MB)를 `process.env.NODE_ENV === 'production'` 가드로 프로덕션 번들에서 완전 제거
- **[정리]** 개발 전용 3개 패키지를 dependencies → devDependencies로 이동
- **[도구]** `/bundle-audit` 커스텀 커맨드 생성 (5단계: 의존성, 동적 임포트, 트리쉐이킹, 라이브러리, 번들 크기)

### 해결된 이슈

- 프로덕션 JS 번들 크기 과대: **3,532 KB → 2,316 KB (-34.4% 감소)**
- 1.1MB 메가 청크 존재: swagger-ui-react(개발 전용 API 문서)가 프로덕션 번들에 포함 → 완전 제거
- 500KB 이상 청크: 1개 → 0개 (최대 청크 220KB)

### 미해결 사항

- `@next/bundle-analyzer`가 Turbopack과 비호환 → `--experimental-analyze` 또는 `--webpack` 플래그로 대체 가능하나 타입 에러(`app-review-demo/page.tsx:66`)로 Webpack 빌드 실패
- `next/dynamic`의 `ssr: false`는 Server Component(layout.tsx)에서 사용 불가 → FacebookSDK는 내부 가드 의존

---

### 규칙/메모리 업데이트

#### 새로 배운 패턴

- **Server Component + `ssr: false` 불가**: `next/dynamic`의 `ssr: false`는 Client Component에서만 사용 가능. Server Component에서 클라이언트 전용 로직은 컴포넌트 내부에서 `window` 가드로 처리
- **Turbopack + bundle-analyzer 비호환**: Next.js 16 기본 번들러 Turbopack에서는 `@next/bundle-analyzer` 미작동. `--experimental-analyze` 플래그 사용 가능
- **`process.env.NODE_ENV` 빌드 타임 치환**: 프로덕션 빌드 시 dead code elimination 활용하여 dev-only 라이브러리를 완전 제거 가능
- **devDependencies vs dependencies**: 번들러는 import 기준으로 번들링하므로 devDependencies 이동만으로는 번들 크기 불변. 코드 레벨 조건부 로딩 필수

---

### 다음 작업 To-Do (업데이트)

#### 우선순위 높음 (P0)

- [ ] `app-review-demo/page.tsx:66` 타입 에러 수정: Webpack 빌드 호환성 확보 (관련 파일: `src/app/(dashboard)/app-review-demo/page.tsx`)
- [ ] 랜딩페이지 추가 해상도 테스트: 768px(태블릿), 375px(모바일) (관련 파일: `src/presentation/components/landing/`)

#### 우선순위 보통 (P1)

- [ ] 전체 테스트 실행 확인: `npx vitest run` (번들 최적화 후 테스트 통과 여부)
- [ ] Meta 앱 검수 스크린캐스트 녹화 진행 (관련 파일: `docs/meta-app-review/RECORDING_SCRIPT.md`)
- [ ] `@react-pdf/renderer` 서버사이드 전용 확인 완료 - 클라이언트 번들 미포함 (추가 조치 불필요)

#### 나중에 (P2)

- [ ] `--webpack` 모드 번들 분석: 타입 에러 수정 후 `ANALYZE=true npx next build --webpack`으로 상세 모듈별 크기 분석
- [ ] Sentry SDK 번들 크기 추가 최적화: `@sentry/nextjs` 클라이언트 번들 기여도 측정

---

## 세션 3 (21:30) - 렌더링 전략 최적화

### 변경 파일 (22개 수정 + 21개 신규)

**수정된 페이지 (22개)**

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/app/page.tsx` | 수정 | auth() 제거 → ISR `revalidate=3600` + AuthRedirect 클라이언트 리다이렉트 |
| `src/app/(legal)/privacy/page.tsx` | 수정 | `revalidate=86400` → `dynamic='force-static'` (SSG) |
| `src/app/(legal)/terms/page.tsx` | 수정 | `revalidate=86400` → `dynamic='force-static'` (SSG) |
| `src/app/checkout/fail/page.tsx` | 수정 | CSR → RSC (searchParams 서버 props 처리, JS 번들 제거) |
| `src/app/(dashboard)/settings/page.tsx` | 수정 | `'use client'` 제거 (불필요 — 순수 정적 UI) |
| `src/app/(dashboard)/insights-demo/page.tsx` | 수정 | Suspense boundary 추가 (스트리밍 렌더링) |
| `src/app/(dashboard)/dashboard/page.tsx` | 수정 | CSR → RSC 셸 + DashboardClient |
| `src/app/(dashboard)/campaigns/page.tsx` | 수정 | CSR → RSC + CampaignsClient |
| `src/app/(dashboard)/campaigns/[id]/page.tsx` | 수정 | CSR → RSC + CampaignDetailClient |
| `src/app/(dashboard)/campaigns/[id]/edit/page.tsx` | 수정 | useEffect+fetch → RSC 서버 데이터 로딩 |
| `src/app/(dashboard)/campaigns/[id]/analytics/page.tsx` | 수정 | CSR → RSC + AnalyticsClient |
| `src/app/(dashboard)/reports/page.tsx` | 수정 | CSR → RSC + ReportsClient |
| `src/app/(dashboard)/reports/[id]/page.tsx` | 수정 | CSR → RSC + ReportDetailClient |
| `src/app/(dashboard)/reports/sample/page.tsx` | 수정 | CSR → SSG `force-static` (정적 데이터) |
| `src/app/(dashboard)/app-review-demo/page.tsx` | 수정 | useEffect+fetch → RSC + AppReviewClient |
| `src/app/(admin)/admin/page.tsx` | 수정 | useEffect+fetch → 완전 RSC |
| `src/app/(admin)/admin/users/page.tsx` | 수정 | CSR → RSC + UsersFilterBar |
| `src/app/(admin)/admin/users/[id]/page.tsx` | 수정 | CSR → RSC + UserRoleDialog |
| `src/app/(admin)/admin/payments/page.tsx` | 수정 | CSR → RSC + PaymentsFilterBar |
| `src/app/(admin)/admin/refunds/page.tsx` | 수정 | CSR → RSC + RefundActions |
| `src/app/(admin)/admin/analytics/page.tsx` | 수정 | CSR → RSC + AnalyticsPeriodSelector |
| `src/app/(admin)/admin/settings/page.tsx` | 수정 | CSR → RSC + AdminRoleManagement |

**신규 클라이언트 컴포넌트 (20개)**

| 파일 | 설명 |
|------|------|
| `src/presentation/components/common/AuthRedirect.tsx` | 랜딩 ISR용 세션 체크 + 리다이렉트 |
| `src/app/(dashboard)/dashboard/DashboardClient.tsx` | 대시보드 인터랙티브 영역 |
| `src/app/(dashboard)/campaigns/CampaignsClient.tsx` | 캠페인 목록 필터/정렬 |
| `src/app/(dashboard)/campaigns/[id]/CampaignDetailClient.tsx` | 캠페인 상태 변경 액션 |
| `src/app/(dashboard)/campaigns/[id]/edit/CampaignEditClient.tsx` | 캠페인 수정 폼 |
| `src/app/(dashboard)/campaigns/[id]/analytics/AnalyticsClient.tsx` | 분석 차트 |
| `src/app/(dashboard)/reports/ReportsClient.tsx` | 보고서 다운로드 액션 |
| `src/app/(dashboard)/reports/[id]/ReportDetailClient.tsx` | 보고서 다운로드/공유 |
| `src/app/(dashboard)/reports/sample/SampleReportActions.tsx` | 샘플 PDF 다운로드/공유 |
| `src/app/(dashboard)/app-review-demo/AppReviewClient.tsx` | Meta 권한 Re-check |
| `src/app/(admin)/admin/users/UsersFilterBar.tsx` | 회원 검색/필터 |
| `src/app/(admin)/admin/users/[id]/UserRoleDialog.tsx` | 역할 변경 다이얼로그 |
| `src/app/(admin)/admin/payments/PaymentsFilterBar.tsx` | 결제 검색/필터 |
| `src/app/(admin)/admin/refunds/RefundActions.tsx` | 환불 승인/거절 |
| `src/app/(admin)/admin/analytics/AnalyticsPeriodSelector.tsx` | 분석 기간 선택 |
| `src/app/(admin)/admin/settings/AdminRoleManagement.tsx` | 관리자 역할 관리 |

**신규 커스텀 커맨드 (1개)**

| 파일 | 설명 |
|------|------|
| `.claude/commands/rendering-audit.md` | `/rendering-audit` 렌더링 전략 감사 커맨드 |

### 핵심 변경사항

- **[렌더링 최적화]** 35개 페이지 중 27개가 CSR('use client')이던 것을 RSC 기반으로 전환: CSR 27→3개, RSC+Islands 4→25개
- **[SSG 전환]** privacy, terms, reports/sample 3개 페이지를 `force-static`으로 빌드 타임 정적 생성
- **[ISR 전환]** 랜딩 페이지에서 auth() 제거 + `revalidate=3600` (1시간 ISR 캐싱)
- **[보안 강화]** checkout/complete에 auth() 인증 체크 추가 (기존: 미인증 접근 가능)
- **[워터폴 제거]** 12개 useEffect+fetch 페이지를 서버 사이드 데이터 fetching으로 전환 (HTML→JS→hydration→API 4단계 → 서버 1단계)
- **[클라이언트 Islands]** 인터랙티브 부분만 별도 클라이언트 컴포넌트로 분리하여 서버 렌더링 HTML 비중 증가

### 해결된 이슈

- 랜딩 페이지 매 요청 동적 렌더링 (auth() 호출): ISR 1시간 캐싱으로 TTFB 200-500ms 개선
- 법적 페이지 불필요한 ISR 재생성: SSG로 CDN 에지 서빙
- checkout/complete 미인증 접근 보안 취약점: auth() 체크 추가
- checkout/fail 불필요한 클라이언트 JS 번들: RSC 전환으로 번들 제거
- 어드민/대시보드 전체 CSR로 인한 데이터 워터폴: 서버 데이터 fetching으로 제거

### 미해결 사항

- Turbopack 미들웨어 호환성 문제로 auth 리다이렉트를 미들웨어로 이전 불가 → AuthRedirect 클라이언트 컴포넌트로 우회
- FacebookSDK가 루트 레이아웃에 위치 (auth 레이아웃으로 이동하면 비인증 페이지 SDK 로드 제거 가능)
- 랜딩 페이지 12개 섹션 중 9개가 'use client' (애니메이션 목적) → 인터랙티브 부분만 격리하는 추가 분리 가능

### 검증 결과

| 항목 | 결과 |
|------|------|
| `npx tsc --noEmit` | 에러 0개 |
| `npx vitest run` | 118파일, 2,138 테스트 전부 통과 |
| `npx next build` | 빌드 성공 (Static: 4개, Dynamic: 나머지) |

---

### 규칙/메모리 업데이트

#### 새로 배운 패턴

- **Turbopack + 미들웨어 auth 비호환**: Next.js 16.1.1 + Turbopack에서 미들웨어가 제대로 실행되지 않음 → auth 리다이렉트는 페이지/레이아웃 레벨에서 처리
- **ISR + 클라이언트 리다이렉트 패턴**: auth() 제거 + ISR 캐싱 + AuthRedirect('use client' + useSession)로 로그인 사용자 리다이렉트 처리
- **RSC + Client Islands 전환 공식**: page.tsx에서 'use client' 제거 → cookies()로 내부 API fetch → 인터랙티브 부분을 별도 클라이언트 컴포넌트로 추출
- **force-static vs revalidate**: 하드코딩 콘텐츠는 `dynamic='force-static'`이 ISR보다 적절 (재생성 불필요)

---

### 다음 작업 To-Do (업데이트)

#### 우선순위 높음 (P0)

- [ ] FacebookSDK를 루트 레이아웃 → auth 레이아웃으로 이동 (관련 파일: `src/app/layout.tsx`, `src/app/(auth)/layout.tsx`)
- [ ] 전환된 RSC 페이지들의 E2E 테스트 실행 및 검증 (관련 파일: `tests/e2e/`)
- [ ] 랜딩페이지 추가 해상도 테스트: 768px(태블릿), 375px(모바일) (관련 파일: `src/presentation/components/landing/`)

#### 우선순위 보통 (P1)

- [ ] Meta 앱 검수 스크린캐스트 녹화 진행 (관련 파일: `docs/meta-app-review/RECORDING_SCRIPT.md`)
- [ ] 랜딩 섹션 'use client' 경계 세분화: 애니메이션 부분만 클라이언트 격리 (관련 파일: `src/presentation/components/landing/`)
- [ ] 백엔드 완성도 분석 및 구현 (관련 파일: `docs/03-analysis/backend-completion.analysis.md`)

#### 나중에 (P2)

- [ ] PPR(Partial Prerendering) 활성화 검토: Turbopack 안정화 후 `next.config.ts:228` 주석 해제
- [ ] RSC 전환 페이지들의 서버 fetch를 직접 DB 조회로 전환 (내부 API 라우트 중복 제거)
- [ ] Sentry SDK 번들 크기 추가 최적화

---

## 세션 4 (22:22) - P0 마무리 (타입 에러, 해상도 테스트, FacebookSDK 이동)

### 변경 파일 (4개)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/app/(dashboard)/app-review-demo/page.tsx` | 수정 | `PermissionEntry` 타입 명시로 Webpack 빌드 타입 에러 해결 |
| `src/app/layout.tsx` | 수정 | FacebookSDK import 및 JSX 제거 (비인증 페이지 SDK 로드 방지) |
| `src/app/(dashboard)/layout.tsx` | 수정 | FacebookSDK + Suspense 추가 (인증 페이지에서만 로드) |
| `src/app/docs/page.tsx` | 수정 | swagger-ui-react 프로덕션 제외 (세션 2에서 시작, 이번 세션에서 빌드 검증 완료) |

### 핵심 변경사항

- **[타입 수정]** `PERMISSIONS` 배열에 `PermissionEntry` 타입 명시 → `as const` 리터럴과 union 타입 간 호환성 문제 해결 (Webpack 빌드 통과)
- **[성능 최적화]** FacebookSDK를 루트 레이아웃 → 대시보드 레이아웃으로 이동 → 랜딩/로그인/법적 페이지에서 SDK 스크립트 제거
- **[해상도 검증]** 375px(모바일), 768px(태블릿) Playwright 스크린샷 캡처 → 레이아웃 정상 확인

### 해결된 이슈

- `app-review-demo/page.tsx:66` Webpack 모드 타입 에러: `PermissionEntry` 명시적 타입으로 해결
- 비인증 페이지 Facebook SDK 불필요 로딩: 루트 → 대시보드 레이아웃 이동으로 제거
- 모바일/태블릿 랜딩페이지 미검증: 375px, 768px 스크린샷으로 정상 확인

### 미해결 사항

- 없음

### 검증 결과

| 항목 | 결과 |
|------|------|
| `npx tsc --noEmit` | ✅ 에러 0개 |
| `npx vitest run` | ✅ 118파일, 2,138 테스트 전부 통과 |
| `npx next build` (Turbopack) | ✅ 빌드 성공 |
| `npx next build --webpack` | ✅ 빌드 성공 (타입 에러 수정 확인) |
| 모바일 375px 스크린샷 | ✅ 정상 |
| 태블릿 768px 스크린샷 | ✅ 정상 |

---

### 규칙/메모리 업데이트

규칙 업데이트 불필요 (세션 2에서 번들 최적화 패턴 이미 기록)

---

### 다음 작업 To-Do (업데이트)

#### 우선순위 높음 (P0)

- 현재 P0 항목 없음 (전부 완료)

#### 우선순위 보통 (P1)

- [ ] Meta 앱 검수 스크린캐스트 녹화 진행 (관련 파일: `docs/meta-app-review/RECORDING_SCRIPT.md`)
- [ ] 랜딩 섹션 'use client' 경계 세분화: 애니메이션 부분만 클라이언트 격리 (관련 파일: `src/presentation/components/landing/`)
- [ ] 백엔드 완성도 분석 및 구현 (관련 파일: `docs/03-analysis/backend-completion.analysis.md`)
- [ ] `ANALYZE=true npx next build --webpack`으로 Webpack 모드 상세 번들 분석 실행

#### 나중에 (P2)

- [ ] PPR(Partial Prerendering) 활성화 검토 (관련 파일: `next.config.ts:228`)
- [ ] RSC 전환 페이지들의 서버 fetch를 직접 DB 조회로 전환
- [ ] Sentry SDK 번들 크기 추가 최적화

---

## 세션 5 (22:27) - 백엔드 캐싱 및 데이터 호출 최적화

### 변경 파일 (17개)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/lib/auth.ts` | 수정 | `getAuthenticatedUser()`를 `React.cache()`로 래핑 (요청당 auth() 중복 호출 제거) |
| `src/app/(dashboard)/layout.tsx` | 수정 | `auth()` 직접 호출 → `getAuthenticatedUser()` 사용으로 통일 |
| `src/app/(dashboard)/campaigns/page.tsx` | 수정 | auth 통일 + ISR `revalidate:60` + tags `['campaigns']`, `['kpi']` |
| `src/app/(dashboard)/reports/page.tsx` | 수정 | auth 통일 + ISR `revalidate:120` + tags `['reports']` |
| `src/app/(dashboard)/campaigns/[id]/page.tsx` | 수정 | auth 통일 + ISR `revalidate:60` + tags `['campaigns']` |
| `src/app/(admin)/admin/page.tsx` | 수정 | ISR `revalidate:300` + tags `['admin-dashboard']` |
| `src/app/api/campaigns/route.ts` | 수정 | POST에 `revalidateTag('campaigns','default')`, `revalidateTag('kpi','default')` 추가 |
| `src/app/api/campaigns/[id]/route.ts` | 수정 | PATCH, DELETE에 `revalidateTag` 추가 |
| `src/app/api/campaigns/[id]/status/route.ts` | 수정 | pause/resume에 `invalidateCache` + `revalidateTag` 추가 (기존: 무효화 없음) |
| `src/app/api/reports/route.ts` | 수정 | POST에 `revalidateTag('reports','default')` 추가 |
| `src/app/api/reports/[id]/route.ts` | 수정 | DELETE에 `revalidateTag('reports','default')` 추가 |
| `src/domain/repositories/IKPIRepository.ts` | 수정 | `aggregateByCampaignIds()` 배치 인터페이스 추가 |
| `src/infrastructure/database/repositories/PrismaKPIRepository.ts` | 수정 | `groupBy` 배치 구현 (N+1 → 단일 쿼리) |
| `src/application/use-cases/kpi/GetDashboardKPIUseCase.ts` | 수정 | execute/calculateComparison에서 for-loop → 배치 호출 |
| `tests/mocks/repositories/MockKPIRepository.ts` | 수정 | `aggregateByCampaignIds()` mock 추가 |
| `src/presentation/hooks/useCampaigns.ts` | 수정 | staleTime `30s` → `120s` |
| `src/app/api/admin/dashboard/route.ts` | 수정 | `findByFilters` + 메모리 필터링 → `prisma.campaign.count()` 4개 병렬 쿼리 |

### 핵심 변경사항

- **[캐싱 P0]** `getAuthenticatedUser()`를 `React.cache()`로 래핑 → 동일 요청 내 auth() 2회 호출 제거
- **[캐싱 P1]** Server Component fetch에 ISR revalidate + tags 적용 (campaigns 60s, reports 120s, admin 300s)
- **[캐싱 P1]** 6개 Mutation 엔드포인트에 `revalidateTag()` 추가 (기존 인메모리 캐시와 병행)
- **[성능 P1]** KPI N+1 쿼리를 `aggregateByCampaignIds()` 배치 호출로 교체 (Prisma groupBy)
- **[캐싱 P0]** TanStack Query `staleTime` 30초 → 120초로 상향 (과도한 refetch 방지)
- **[성능 P2]** Admin 대시보드에서 `findByFilters({}, {limit:1000})` + 메모리 필터링 → `prisma.campaign.count()` 병렬 쿼리

### 해결된 이슈

- 모든 Server Component fetch가 `revalidate: 0`으로 매 요청 DB 쿼리 실행 → ISR 캐싱 적용
- 캠페인 상태변경/보고서 Mutation 후 Next.js 캐시 갱신 안되는 문제 → revalidateTag 추가
- KPI UseCase N+1 쿼리 (캠페인마다 개별 `aggregateByCampaignId()`) → 단일 groupBy 배치 쿼리
- Admin 대시보드 1000건 로딩 후 메모리 필터링 → COUNT 쿼리 4개 병렬 실행
- `revalidateTag()` Next.js 16 시그니처: 2개 인자 필요 `(tag, profile)` → 'default' 프로파일 추가

### 미해결 사항

- `admin-dashboard` 태그는 현재 Mutation에서 무효화되지 않음 (관리자 페이지 빈도 낮아 300초 TTL로 충분)
- ChatService, KPIInsightsService 등 다른 N+1 호출처는 이번 스코프에서 제외

### 검증 결과

| 항목 | 결과 |
|------|------|
| `npx tsc --noEmit` | ✅ 에러 0개 |
| `npx vitest run` | ✅ 118파일, 2,138 테스트 전부 통과 |
| `npx next build` | ✅ 빌드 성공 |

---

### 규칙/메모리 업데이트

#### 새로 배운 패턴

- **revalidateTag Next.js 16 시그니처**: `revalidateTag(tag: string, profile: string)` — 2개 인자 필수. 'default' 프로파일 사용. Next.js 15와 달라짐
- **React.cache() 용도**: 동일 요청 내 동일 함수 결과 메모이제이션 (Layout+Page에서 auth() 2회 호출 방지)
- **인메모리 캐시 + ISR 병행**: `invalidateCache`(인메모리 Map) + `revalidateTag`(Next.js ISR) 동시 적용으로 양쪽 캐시 모두 무효화
- **Prisma groupBy 배치**: N+1 쿼리를 `groupBy({ by: ['campaignId'] })` + `{ in: campaignIds }` 패턴으로 단일 쿼리화

---

### 다음 작업 To-Do (업데이트)

#### 우선순위 높음 (P0)

- 현재 P0 항목 없음 (전부 완료)

#### 우선순위 보통 (P1)

- [ ] Meta 앱 검수 스크린캐스트 녹화 진행 (관련 파일: `docs/meta-app-review/RECORDING_SCRIPT.md`)
- [ ] ChatService, KPIInsightsService N+1 쿼리 배치화 (관련 파일: `src/application/use-cases/`)
- [ ] `admin-dashboard` 태그를 관리자 Mutation에 연결 (관련 파일: `src/app/api/admin/`)
- [ ] 백엔드 완성도 분석 및 구현 (관련 파일: `docs/03-analysis/backend-completion.analysis.md`)

#### 나중에 (P2)

- [ ] PPR(Partial Prerendering) 활성화 검토 (관련 파일: `next.config.ts:228`)
- [ ] RSC 전환 페이지들의 서버 fetch를 직접 DB 조회로 전환
- [ ] `unstable_cache` 적용: dynamicIO 활성화 후 `'use cache'` 전환 검토
- [ ] Sentry SDK 번들 크기 추가 최적화
