# 작업 요약 (2026-02-13)

## 변경 파일 (13개 핵심)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/application/services/ChatService.ts` | 수정 | `buildContext()` N+1 쿼리 → `aggregateByCampaignIds()` 배치 호출로 전환 |
| `src/application/services/KPIInsightsService.ts` | 수정 | `generateInsights()` 3N 개별 쿼리 → 3개 배치 쿼리로 전환, `collectCampaignKPIData` → `buildCampaignKPIData` 리네이밍 |
| `tests/unit/application/services/ChatService.test.ts` | 신규 | ChatService 배치 쿼리 검증 5개 테스트 |
| `tests/unit/application/services/KPIInsightsService.test.ts` | 신규 | KPIInsightsService 배치 쿼리 + 인사이트 로직 5개 테스트 |
| `src/app/api/admin/users/[id]/route.ts` | 수정 | PATCH에 `revalidateTag('admin-dashboard', 'default')` 추가 |
| `src/app/api/admin/refunds/[id]/route.ts` | 수정 | POST(승인)/DELETE(거절)에 `revalidateTag('admin-dashboard', 'default')` 추가 |
| `src/app/api/admin/settings/admins/route.ts` | 수정 | POST(역할변경)에 `revalidateTag('admin-dashboard', 'default')` 추가 |
| `src/app/api/campaigns/route.ts` | 수정 | POST에 `revalidateTag('admin-dashboard', 'default')` 추가 |
| `src/app/api/campaigns/[id]/route.ts` | 수정 | PATCH/DELETE에 `revalidateTag('admin-dashboard', 'default')` 추가 |
| `src/app/api/campaigns/[id]/status/route.ts` | 수정 | pause/resume에 `revalidateTag('admin-dashboard', 'default')` 추가 |
| `src/infrastructure/external/meta-pixel/CAPIClient.ts` | 수정 | `META_MOCK_MODE` 환경변수 기반 mockMode 추가 (3개 메서드) |
| `tests/unit/infrastructure/meta-pixel/CAPIClient.test.ts` | 수정 | mockMode 검증 4개 테스트 추가 |
| `.claude/commands/wrap.md` | 수정 | 4단계(백로그 이관) 추가, P2는 wrap 로그에서 제외 |

### 신규 파일 (3개)

| 파일 | 설명 |
|------|------|
| `.claude/commands/wrap-todo.md` | `/wrap-todo` 커맨드 - 백로그 연동 |
| `docs/backlog.md` | P2a/P2b 백로그 영구 관리 파일 |
| `tests/unit/application/services/ChatService.test.ts` | ChatService 배치 쿼리 테스트 |

## 핵심 변경사항

- **[성능 P1]** ChatService N+1 → 배치: `Promise.all(campaigns.map(async => aggregateByCampaignId))` → `aggregateByCampaignIds()` 단일 호출 (2+N쿼리 → 3쿼리)
- **[성능 P1]** KPIInsightsService N+1 → 배치: for-loop 내 3N 개별 쿼리 → `Promise.all([배치3개])` (1+3N쿼리 → 4쿼리)
- **[캐싱 P1]** admin-dashboard ISR 태그를 8개 Mutation 엔드포인트에 연결 (기존: TTL 300초 의존)
- **[완성도 P1]** CAPIClient에 `META_MOCK_MODE` mockMode 추가 → 백엔드 완성도 96.6% → 100%
- **[도구]** `/wrap` 4단계 백로그 자동 이관, `/wrap-todo` 백로그 승격 확인, `docs/backlog.md` 영구 관리

## 해결된 이슈

- ChatService `buildContext()` N+1 쿼리: 캠페인 10개 시 개별 `aggregateByCampaignId` 10회 호출 → 배치 1회로 감소
- KPIInsightsService `generateInsights()` N+1 쿼리: 캠페인 10개 시 30회(3*10) 호출 → 배치 3회로 감소
- admin-dashboard ISR 캐시가 관리자 Mutation(사용자 수정, 환불 처리, 역할 변경) 후 갱신되지 않던 문제 해결
- CAPIClient가 Meta API 없이 동작할 수 없던 문제 → mockMode로 오프라인 개발 가능
- P2 항목이 매 wrap마다 복사-붙여넣기로 누적되던 문제 → `docs/backlog.md` 분리

## 미해결 사항

- OMC 플러그인 `persistent-mode.cjs` 경로 오류: `CLAUDE_PLUGIN_ROOT`가 존재하지 않는 4.0.5 경로 참조 → `omc update` 필요
- MetaAdsClient.test.ts 9개 테스트 실패 (사전 존재 - MSW Bearer 토큰 파싱 문제)
- PerplexityResearchService.test.ts 2개 테스트 실패 (사전 존재)

---

## 규칙/메모리 업데이트

### 새로 배운 패턴

- **Campaign.restore() vs create()**: 테스트에서 과거 날짜로 캠페인 생성 시 `create()`는 도메인 검증(시작일 미래)으로 실패 → `restore()`는 검증 스킵
- **Mock 내부 위임 주의**: `MockKPIRepository.aggregateByCampaignIds`가 내부적으로 `aggregateByCampaignId`를 호출하므로 spy 기반 "not called" 검증이 실패할 수 있음

규칙 업데이트 불필요 (메모리 파일에 이미 기록된 패턴과 동일)

---

## 다음 작업 To-Do

### 우선순위 높음 (P0)

- 현재 P0 항목 없음

### 우선순위 보통 (P1)

- [ ] OMC 플러그인 업데이트: `omc update` 실행하여 4.0.5 → 4.2.5 캐시 동기화 (관련: `~/.claude/plugins/`)
- [ ] 전환된 RSC 페이지들의 E2E 테스트 실행 및 검증 (관련 파일: `tests/e2e/`)
- [ ] `ANALYZE=true npx next build --webpack`으로 Webpack 모드 상세 번들 분석 실행

---

### 백로그 변동
- 신규 이관: 0개
- 완료 제거: 0개
- 현재 총: P2a 3개, P2b 6개 → [docs/backlog.md](../backlog.md)

---

### 검증 결과

| 항목 | 결과 |
|------|------|
| `npx tsc --noEmit` | 에러 0개 |
| `npx vitest run` | 125파일, 2,227 테스트 (2,217 통과, 10 실패 - 사전 존재) |
| 이번 세션 테스트 | 14개 신규 테스트 전부 통과 |

---

## 세션 2 (21:10)

## 작업 요약 (2026-02-13 세션 2)

### 변경 파일 (2개)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/presentation/components/dashboard/CampaignSummaryTable.tsx` | 수정 | 지출 표시 "원1,127원" → "1,127원" 중복 접두사 제거 |
| `src/presentation/components/alerts/NotificationCenter.tsx` | 수정 | 동일한 `t('currency.krw')` 중복 접두사 제거 |

### 핵심 변경사항

- **[버그 수정]** `t('currency.krw')` + 값 + `t('currency.suffix')` 패턴에서 "원"이 앞뒤 중복 표시되던 버그 수정 (2곳)
- **[확인]** KPIChart.tsx 라인차트 리디자인 시도 → 사용자 피드백으로 원복
- **[확인]** 캠페인 생성 마법사 UI 전체 구현 상태 검증 — Advantage+ 4단계/수동 6단계 모두 구현 완료 확인
- **[확인]** `prisma db push` → DB 스키마 이미 동기화 상태 확인 (AdSet/Ad/Creative 테이블 존재)

### 해결된 이슈

- 대시보드 "캠페인 현황" 테이블의 지출 컬럼에 "원1,127원" 표시되던 문제 → "1,127원"으로 수정
- NotificationCenter CPA/지출 포맷팅 동일 패턴 수정

### 미해결 사항

- 없음

---

## 규칙/메모리 업데이트

### 새로 배운 패턴

- **i18n 통화 포맷 중복 주의**: `t('currency.krw')` (접두사 "원") + `t('currency.suffix')` (접미사 "원") 동시 사용 시 한국어 원화는 접미사만 사용해야 함. 접두사는 $ 등 다른 통화용.

규칙 업데이트 불필요 (단발성 버그 수정)

---

## 다음 작업 To-Do

### 우선순위 높음 (P0)

- 현재 P0 항목 없음

### 우선순위 보통 (P1)

- [ ] 캠페인 생성 마법사 브라우저 테스트: `/campaigns/new`에서 Advantage+ 플로우 전체 수동 검증 (관련 파일: `src/app/(dashboard)/campaigns/new/page.tsx`)
- [ ] 마법사로 테스트 캠페인 생성 후 캠페인 상세에서 AdSet 목록 표시 확인 (관련 파일: `src/presentation/components/campaign/AdSetList.tsx`)
- [ ] 자동 동기화 Vercel Cron Job 구현 (관련 파일: `src/app/api/cron/sync/route.ts` 신규)

---

### 백로그 변동
- 신규 이관: 0개
- 완료 제거: 0개
- 현재 총: P2a 3개, P2b 6개 → [docs/backlog.md](../backlog.md)

---

### 검증 결과

| 항목 | 결과 |
|------|------|
| `npx tsc --noEmit` | 에러 0개 |
| `npx vitest run` | 125파일, 2,226 테스트 통과 |

---

## 세션 3 (20:38) - 클린 아키텍처 검증 및 수정

## 작업 요약 (2026-02-13 세션 3)

### 변경 파일 (17개)

| 파일 | 변경 유형 | 설명 |
|------|----------|------|
| `src/domain/value-objects/Industry.ts` | **신규** | Industry, CopyHookType, IndustryBenchmark 타입 + INDUSTRY_BENCHMARKS 상수를 infrastructure → domain으로 이동 |
| `src/application/ports/IReportPDFGenerator.ts` | **신규** | PDFGeneratorResult + IReportPDFGenerator 인터페이스를 infrastructure → application/ports로 추출 |
| `src/application/utils/BillingKeyEncryption.ts` | **신규** | encryptBillingKey/decryptBillingKey 함수를 infrastructure → application/utils로 이동 |
| `src/application/services/ReportSchedulerService.ts` | 수정 | import `@infrastructure/pdf` → `@application/ports/IReportPDFGenerator` |
| `src/application/services/CampaignAnalyzer.ts` | 수정 | import `@infrastructure/external/openai` → `@domain/value-objects/Industry` |
| `src/application/services/CompetitorBenchmarkService.ts` | 수정 | import `@infrastructure/external/openai` → `@domain/value-objects/Industry` |
| `src/application/services/CopyLearningService.ts` | 수정 | import `@infrastructure/external/openai` → `@domain/value-objects/Industry` |
| `src/application/use-cases/payment/SubscribePlanUseCase.ts` | 수정 | import `@infrastructure/payment` → `@application/utils/BillingKeyEncryption` |
| `src/application/use-cases/payment/ChangePlanUseCase.ts` | 수정 | import `@infrastructure/payment` → `@application/utils/BillingKeyEncryption` |
| `src/application/use-cases/payment/IssueBillingKeyUseCase.ts` | 수정 | import `@infrastructure/payment` → `@application/utils/BillingKeyEncryption` |
| `src/application/ports/IPaymentGateway.ts` | 수정 | BillingKeyResult/ChargeResult/CancelResult/PaymentDetail 4개 타입을 인라인 정의 (infrastructure import 제거) |
| `src/infrastructure/payment/TossPaymentsClient.ts` | 수정 | 타입을 port에서 import + re-export (하위 호환) |
| `src/infrastructure/pdf/ReportPDFGenerator.ts` | 수정 | 인터페이스를 port에서 import + re-export (하위 호환) |
| `src/infrastructure/external/openai/prompts/adCopyGeneration.ts` | 수정 | ~136줄 타입 정의 → domain에서 import + re-export (하위 호환) |
| `src/infrastructure/payment/BillingKeyEncryption.ts` | 수정 | 전체 구현 → application/utils에서 thin re-export |
| `src/lib/di/types.ts` | 수정 | PlatformAdapter, MetaPixelService, CAPIService 3개 DI 토큰 추가 |
| `src/lib/di/container.ts` | 수정 | 3개 포트의 구현체 등록 (Cafe24Adapter, MetaPixelClient, CAPIClient) |

### 핵심 변경사항

- **[아키텍처 수정]** application→infrastructure 의존성 위반 10건 해결: 타입/인터페이스/유틸을 올바른 레이어로 이동
- **[DI 등록 수정]** 포트 인터페이스 3개(IPlatformAdapter, IMetaPixelService, ICAPIService)에 DI 토큰 + 컨테이너 등록 추가
- **[하위 호환]** infrastructure 파일에서 이동된 타입을 re-export하여 기존 내부 import 유지
- **[검증 스킬]** verify-architecture, verify-di-registration, verify-cache-tags, verify-bundle 4개 자동 검증 스킬 구축 및 실행

### 해결된 이슈

- application 레이어에서 infrastructure를 직접 import하는 클린 아키텍처 위반 10건 → 모두 수정
- IPaymentGateway가 TossPaymentsClient에서 타입 import → 포트 파일 내 인라인 정의로 독립화
- 3개 포트 인터페이스(IPlatformAdapter, IMetaPixelService, ICAPIService)가 DI 컨테이너에 미등록 → 등록 완료

### 미해결 사항

- `CampaignSummaryTable.test.tsx:116` 통화 포맷 테스트 1건 실패 (사전 존재, 이번 세션과 무관)

---

## 규칙/메모리 업데이트

### 새로 배운 패턴

- **re-export 하위 호환 패턴**: 타입/함수를 올바른 레이어로 이동한 후, 원래 infrastructure 파일에서 `export { X } from '@application/...'` re-export → 기존 내부 import 깨지지 않음
- **포트 인터페이스 타입 독립 원칙**: `IPaymentGateway` 같은 포트 파일이 구현체(TossPaymentsClient)에서 타입 import하면 의존성 역전 위반 → 포트 파일에 타입 인라인 정의 필수
- **verify 스킬 시스템**: `.claude/skills/verify-*/SKILL.md`에 자동화된 아키텍처 검증 규칙을 정의하면 `/verify-implementation`으로 일괄 실행 가능

규칙 업데이트: 메모리 파일에 verify 스킬 시스템 관련 패턴 기록 예정

---

## 다음 작업 To-Do

### 우선순위 높음 (P0)

- 현재 P0 항목 없음

### 우선순위 보통 (P1)

- [ ] Prisma migrate 실행: AdSet/Ad/Creative/CreativeAsset 테이블 DB 적용 (관련 파일: `prisma/schema.prisma`)
- [ ] 캠페인 생성 마법사 브라우저 테스트: `/campaigns/new`에서 Advantage+ 플로우 전체 수동 검증 (관련 파일: `src/app/(dashboard)/campaigns/new/page.tsx`)
- [ ] CampaignSummaryTable 통화 포맷 테스트 수정 (관련 파일: `tests/unit/presentation/components/campaign/CampaignSummaryTable.test.tsx:116`)

---

### 백로그 변동
- 신규 이관: 0개
- 완료 제거: 0개
- 현재 총: P2a 3개, P2b 6개 → [docs/backlog.md](../backlog.md)

---

### 검증 결과

| 항목 | 결과 |
|------|------|
| `npx tsc --noEmit` | ✅ 에러 0개 |
| `npx vitest run` | ✅ 2,225/2,226 통과 (1건 사전 존재 실패) |
| verify-architecture | ✅ PASS (수정 후 0건 위반) |
| verify-di-registration | ✅ PASS (수정 후 0건 누락) |
| verify-cache-tags | ✅ PASS |
| verify-bundle | ✅ PASS |
