openapi: 3.0.3
info:
  title: Batwo AI Marketing Solution API
  description: |
    커머스 사업자를 위한 AI 마케팅 대행 솔루션 API

    ## 주요 기능
    - Meta 광고 캠페인 자동화
    - KPI 대시보드 및 분석
    - AI 기반 광고 카피 생성
    - 주간/월간 보고서 생성
    - Meta 픽셀 관리
    - 사용량 할당량 관리

    ## 인증
    모든 API 엔드포인트는 NextAuth.js 세션 기반 인증을 사용합니다.
    Bearer 토큰은 NextAuth 세션 토큰입니다.

  version: 1.0.0
  contact:
    name: Batwo Support
    email: support@batwo.ai
  license:
    name: Proprietary

servers:
  - url: http://localhost:3000
    description: 개발 서버
  - url: https://staging.batwo.ai
    description: 스테이징 서버
  - url: https://batwo.ai
    description: 프로덕션 서버

tags:
  - name: Campaigns
    description: 캠페인 관리 (생성, 조회, 수정, 동기화)
  - name: KPI
    description: 성과 지표 및 대시보드 데이터
  - name: Reports
    description: 주간/월간 보고서 생성 및 관리
  - name: Pixel
    description: Meta 픽셀 설치 및 추적
  - name: AI
    description: AI 기반 카피 생성 및 분석
  - name: Quota
    description: 사용량 할당량 조회
  - name: Permissions
    description: 팀 권한 관리
  - name: Meta
    description: Meta 계정 연동 및 관리
  - name: Health
    description: 시스템 헬스체크

security:
  - BearerAuth: []

paths:
  # Health
  /api/health:
    get:
      tags: [Health]
      summary: 헬스 체크
      description: API 서버 상태 확인
      security: []
      responses:
        '200':
          description: 정상 작동
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

  # Campaigns
  /api/campaigns:
    get:
      tags: [Campaigns]
      summary: 캠페인 목록 조회
      description: 사용자의 캠페인 목록을 페이지네이션하여 조회
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - name: status
          in: query
          description: 캠페인 상태 필터
          schema:
            $ref: '#/components/schemas/CampaignStatus'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaigns:
                    type: array
                    items:
                      $ref: '#/components/schemas/Campaign'
                  total:
                    type: integer
                  page:
                    type: integer
                  pageSize:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [Campaigns]
      summary: 캠페인 생성
      description: 새로운 광고 캠페인 생성 (선택적으로 Meta Ads와 동기화)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCampaignRequest'
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Campaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: 중복된 캠페인 이름
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/campaigns/sync:
    post:
      tags: [Campaigns]
      summary: Meta 캠페인 동기화
      description: Meta Ads 캠페인 및 KPI 데이터 동기화
      responses:
        '200':
          description: 동기화 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  campaigns:
                    type: object
                    properties:
                      created:
                        type: integer
                      updated:
                        type: integer
                      archived:
                        type: integer
                      total:
                        type: integer
                  insights:
                    type: object
                    properties:
                      synced:
                        type: integer
                      failed:
                        type: integer
                      total:
                        type: integer
                  message:
                    type: string
        '400':
          description: Meta 연결 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/campaigns/{id}:
    get:
      tags: [Campaigns]
      summary: 캠페인 상세 조회
      parameters:
        - $ref: '#/components/parameters/CampaignId'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Campaign'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    patch:
      tags: [Campaigns]
      summary: 캠페인 수정
      parameters:
        - $ref: '#/components/parameters/CampaignId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCampaignRequest'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Campaign'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # KPI
  /api/dashboard/kpi:
    get:
      tags: [KPI]
      summary: 대시보드 KPI 조회
      description: 대시보드 주요 성과 지표 조회
      parameters:
        - name: dateRange
          in: query
          required: true
          schema:
            type: string
            enum: [today, yesterday, last_7d, last_30d]
        - name: campaignIds
          in: query
          description: 특정 캠페인 필터 (쉼표 구분)
          schema:
            type: string
        - name: includeComparison
          in: query
          description: 이전 기간 비교 포함
          schema:
            type: boolean
            default: false
        - name: includeBreakdown
          in: query
          description: 캠페인별 분석 포함
          schema:
            type: boolean
            default: false
        - name: includeChartData
          in: query
          description: 차트 데이터 포함
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardKPI'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Reports
  /api/reports:
    get:
      tags: [Reports]
      summary: 보고서 목록 조회
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - name: type
          in: query
          description: 보고서 유형 필터
          schema:
            type: string
            enum: [WEEKLY, MONTHLY]
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  reports:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReportSummary'
                  total:
                    type: integer
                  page:
                    type: integer
                  pageSize:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [Reports]
      summary: 보고서 생성
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [campaignIds, startDate, endDate]
              properties:
                campaignIds:
                  type: array
                  items:
                    type: string
                  minItems: 1
                startDate:
                  type: string
                  format: date
                endDate:
                  type: string
                  format: date
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: 권한 없음 (다른 사용자의 캠페인)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/reports/{id}:
    get:
      tags: [Reports]
      summary: 보고서 상세 조회
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # Pixel
  /api/pixel:
    get:
      tags: [Pixel]
      summary: 픽셀 목록 조회
      parameters:
        - $ref: '#/components/parameters/Page'
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: isActive
          in: query
          schema:
            type: boolean
        - name: setupMethod
          in: query
          schema:
            type: string
            enum: [MANUAL, CAFE24_AUTO, SHOPIFY_AUTO]
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MetaPixel'
                  total:
                    type: integer
                  page:
                    type: integer
                  limit:
                    type: integer
                  totalPages:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [Pixel]
      summary: 픽셀 생성/선택
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [metaPixelId, name, setupMethod]
              properties:
                metaPixelId:
                  type: string
                name:
                  type: string
                setupMethod:
                  type: string
                  enum: [MANUAL, CAFE24_AUTO, SHOPIFY_AUTO]
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetaPixel'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: 픽셀 이미 존재
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  # AI
  /api/ai/copy:
    post:
      tags: [AI]
      summary: AI 광고 카피 생성
      description: |
        AI를 사용하여 광고 카피 생성

        ### 스트리밍 모드
        `?stream=true` 쿼리 파라미터를 사용하면 Server-Sent Events (SSE) 형식으로 스트리밍 응답을 받을 수 있습니다.
      parameters:
        - name: stream
          in: query
          description: 스트리밍 응답 활성화
          schema:
            type: boolean
            default: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateCopyRequest'
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateCopyResponse'
            text/event-stream:
              schema:
                type: string
                description: SSE 스트림 (stream=true인 경우)
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          description: 할당량 초과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags: [AI]
      summary: 카피 생성 힌트 조회
      parameters:
        - name: industry
          in: query
          required: true
          schema:
            type: string
            enum: [ecommerce, food_beverage, beauty, fashion, education, service, saas, health]
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CopyHints'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Quota
  /api/quota:
    get:
      tags: [Quota]
      summary: 사용량 할당량 조회
      description: 현재 사용자의 사용량 할당량 및 잔여량 조회
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuotaStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Permissions
  /api/permissions:
    get:
      tags: [Permissions]
      summary: 사용자 권한 조회
      parameters:
        - name: teamId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: array
                    items:
                      type: string
                  role:
                    type: string
                    enum: [OWNER, ADMIN, MEMBER, VIEWER]
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # Meta
  /api/meta/callback:
    get:
      tags: [Meta]
      summary: Meta OAuth 콜백
      description: Meta 계정 연동 OAuth 콜백 엔드포인트
      security: []
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          schema:
            type: string
      responses:
        '302':
          description: 리다이렉트
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/meta/pending-accounts:
    get:
      tags: [Meta]
      summary: 대기 중인 Meta 계정 조회
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  accounts:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: NextAuth.js 세션 토큰

  parameters:
    Page:
      name: page
      in: query
      description: 페이지 번호 (1부터 시작)
      schema:
        type: integer
        minimum: 1
        default: 1

    PageSize:
      name: pageSize
      in: query
      description: 페이지당 항목 수
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 10

    CampaignId:
      name: id
      in: path
      required: true
      description: 캠페인 ID
      schema:
        type: string

  schemas:
    # Campaign schemas
    Campaign:
      $ref: './schemas/Campaign.yaml#/Campaign'

    CreateCampaignRequest:
      $ref: './schemas/Campaign.yaml#/CreateCampaignRequest'

    UpdateCampaignRequest:
      $ref: './schemas/Campaign.yaml#/UpdateCampaignRequest'

    CampaignStatus:
      $ref: './schemas/Campaign.yaml#/CampaignStatus'

    CampaignObjective:
      $ref: './schemas/Campaign.yaml#/CampaignObjective'

    # KPI schemas
    DashboardKPI:
      $ref: './schemas/KPI.yaml#/DashboardKPI'

    # Report schemas
    Report:
      $ref: './schemas/Report.yaml#/Report'

    ReportSummary:
      $ref: './schemas/Report.yaml#/ReportSummary'

    # Pixel schemas
    MetaPixel:
      $ref: './schemas/Pixel.yaml#/MetaPixel'

    # AI schemas
    GenerateCopyRequest:
      $ref: './schemas/AI.yaml#/GenerateCopyRequest'

    GenerateCopyResponse:
      $ref: './schemas/AI.yaml#/GenerateCopyResponse'

    CopyHints:
      $ref: './schemas/AI.yaml#/CopyHints'

    # Quota schemas
    QuotaStatus:
      $ref: './schemas/Quota.yaml#/QuotaStatus'

    # Common schemas
    Error:
      $ref: './schemas/common.yaml#/Error'

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Unauthorized

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    RateLimitExceeded:
      description: Rate limit 초과
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: 시간당 최대 요청 수
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: 남은 요청 수
        X-RateLimit-Reset:
          schema:
            type: integer
          description: 리셋 시간 (Unix timestamp)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalError:
      description: 서버 내부 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
